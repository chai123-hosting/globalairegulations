<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Global AI Regulation Hub</title>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      header {
        background-color: #333;
        color: #fff;
        padding: 1em;
        text-align: center;
      }
      main {
        padding: 2em;
      }
      #map,
      #world-map {
        display: flex;
        justify-content: center;
      }
      #regulations {
        margin-top: 20px;
      }
      #loading {
        text-align: center;
        margin-top: 20px;
        display: none;
      }
      #regulations-container {
        margin-top: 20px;
      }
      .regulation {
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
      }
      .regulation h5 {
        margin-top: 5px;
      }
      .regulation p {
        margin-bottom: 20px;
      }
      .state {
        fill: #ccc;
        stroke: #fff;
        stroke-width: 0.5px;
      }
      .state:hover {
        fill: #999;
      }
      .state.active {
        fill: #1fd1bf;
      }
      #state-name {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 24px;
        font-weight: bold;
      }
      .nav-menu {
        background-color: #333;
        overflow: hidden;
      }
      .nav-menu a {
        float: left;
        color: #f2f2f2;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
        font-size: 17px;
      }
      .nav-menu a:hover {
        background-color: #ddd;
        color: black;
      }
      .nav-menu a.active {
        background-color: #1fd1bf;
        color: white;
      }
      #worldwide {
        display: none;
      }
      #worldwide-container {
        margin-top: 20px;
      }
      .country-legislation {
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
      }
      .country-legislation h5 {
        margin-top: 5px;
      }
      .country-legislation p {
        margin-bottom: 20px;
      }
      .country {
        fill: #ccc;
        stroke: #fff;
        stroke-width: 0.5px;
      }
      .country:hover {
        fill: #999;
      }
      .country.active {
        fill: #1fd1bf;
      }
      .regulation,
      .country-legislation {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s ease-in-out;
      }

      .timeline {
        position: relative;
        padding: 60px 0;
        margin: 30px 0;
        height: auto;
        min-height: 200px;
        overflow: visible;
      }

      .regulation:hover,
      .country-legislation:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      #regulations-container,
      #worldwide-container {
        max-width: 800px;
        margin: 0 auto;
      }
      .regulation h5,
      .country-legislation h5 {
        font-size: 1.2em;
        font-weight: bold;
        font-family: Arial, sans-serif;
        color: #1fd1bf;
        margin-bottom: 20px;
      }
      .timeline {
        position: relative;
        padding: 20px 0;
        margin: 30px 0;
        overflow: hidden;
      }
      footer {
        background-color: #f4f4f4;
        padding: 10px;
        text-align: center;
        font-size: 0.9em;
        color: #666;
        margin-top: 20px;
      }
      .error-message {
        background-color: #fee;
        border: 1px solid #fcc;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        color: #c33;
      }
      .success-message {
        background-color: #efe;
        border: 1px solid #cfc;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        color: #3c3;
      }
      .loading-progress {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        color: #1976d2;
      }
    </style>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  </head>
  <body>
    <header>
      <h1>Global Artificial Intelligence Regulation Hub</h1>
    </header>
    <div class="nav-menu">
      <a href="#" id="us-link" class="active">United States</a>
      <a href="#" id="worldwide-link">Global</a>
    </div>
    <main>
      <div id="us">
        <h2>US Artificial Intelligence Regulations</h2>
        <div id="map"></div>
        <div id="state-name"></div>
        <div id="loading">Loading legislation...</div>
        <div id="regulations">
          <div id="regulations-container"></div>
        </div>
      </div>
      <div id="worldwide">
        <h2>Global Artificial Intelligence Regulations</h2>
        <div id="world-map"></div>
        <div id="worldwide-container"></div>
      </div>
      <footer id="us-footer">
        <p>Source: Legiscan</p>
      </footer>
      <footer id="worldwide-footer" style="display: none">
        <p>Source: Digital Policy Alerts</p>
      </footer>
    </main>
    <script>
      const stateNameToAbbreviation = {
        Alabama: "AL",
        Alaska: "AK",
        Arizona: "AZ",
        Arkansas: "AR",
        California: "CA",
        Colorado: "CO",
        Connecticut: "CT",
        Delaware: "DE",
        Florida: "FL",
        Georgia: "GA",
        Hawaii: "HI",
        Idaho: "ID",
        Illinois: "IL",
        Indiana: "IN",
        Iowa: "IA",
        Kansas: "KS",
        Kentucky: "KY",
        Louisiana: "LA",
        Maine: "ME",
        Maryland: "MD",
        Massachusetts: "MA",
        Michigan: "MI",
        Minnesota: "MN",
        Mississippi: "MS",
        Missouri: "MO",
        Montana: "MT",
        Nebraska: "NE",
        Nevada: "NV",
        "New Hampshire": "NH",
        "New Jersey": "NJ",
        "New Mexico": "NM",
        "New York": "NY",
        "North Carolina": "NC",
        "North Dakota": "ND",
        Ohio: "OH",
        Oklahoma: "OK",
        Oregon: "OR",
        Pennsylvania: "PA",
        "Rhode Island": "RI",
        "South Carolina": "SC",
        "South Dakota": "SD",
        Tennessee: "TN",
        Texas: "TX",
        Utah: "UT",
        Vermont: "VT",
        Virginia: "VA",
        Washington: "WA",
        "West Virginia": "WV",
        Wisconsin: "WI",
        Wyoming: "WY",
      };

      // Global legislation data storage
      let worldwideLegislationData = [];
      let isLoadingWorldwideData = false;

      // Cache keys
      const CACHE_KEY = 'worldwideRegulations';
      const CACHE_TIMESTAMP_KEY = 'worldwideRegulationsTimestamp';
      const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours
      
      // OPTIONAL: Add your API key here for testing (don't commit to public repos)
      // Leave empty for production - will use public endpoint with CORS proxy
      const DPA_API_KEY = ''; // Format: 'your-api-key-here'

      // Function to check if cache is valid
      function isCacheValid() {
        const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
        if (!timestamp) return false;
        
        const cacheAge = Date.now() - parseInt(timestamp);
        return cacheAge < CACHE_DURATION;
      }

      // Function to load cached data
      function loadCachedData() {
        if (isCacheValid()) {
          const cachedData = localStorage.getItem(CACHE_KEY);
          if (cachedData) {
            try {
              worldwideLegislationData = JSON.parse(cachedData);
              console.log(`Loaded ${worldwideLegislationData.length} regulations from cache`);
              return true;
            } catch (error) {
              console.error("Error parsing cached data:", error);
              localStorage.removeItem(CACHE_KEY);
              localStorage.removeItem(CACHE_TIMESTAMP_KEY);
            }
          }
        }
        return false;
      }

      // Function to save data to cache
      function saveCacheData(data) {
        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify(data));
          localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
          console.log("Data saved to cache");
        } catch (error) {
          console.error("Error saving to cache:", error);
        }
      }

      // US MAP CODE - Original sophisticated implementation
      const width = 960;
      const height = 600;

      const svg = d3
        .select("#map")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const projection = d3
        .geoAlbersUsa()
        .scale(1000)
        .translate([width / 2, height / 2]);

      const path = d3.geoPath().projection(projection);

      const searchTerms = [
        '"artificial intelligence"',
        '"machine learning"',
        '"deep learning"',
        '"neural network"',
        '"generative AI"',
        '"autonomous system"',
        '"algorithmic decision"',
        '"AI ethics"',
        '"AI regulation"',
        '"AI policy"',
        '"automated decision"',
        '"AI governance"',
      ];

      // Cache for state legislation data
      const stateDataCache = {};

      const isRelevant = (bill) => {
        const text = (
          bill.title +
          " " +
          (bill.description || "")
        ).toLowerCase();
        return searchTerms.some((term) =>
          text.includes(term.toLowerCase().replace(/"/g, ""))
        );
      };

      const calculateRelevanceScore = (bill) => {
        const text = (
          bill.title +
          " " +
          (bill.description || "")
        ).toLowerCase();
        return searchTerms.reduce((score, term) => {
          const count = (
            text.match(new RegExp(term.toLowerCase().replace(/"/g, ""), "g")) ||
            []
          ).length;
          return score + count;
        }, 0);
      };

      const fetchLegislation = async (state) => {
        // Check cache first
        if (stateDataCache[state]) {
          console.log(`Using cached data for ${state}`);
          displayLegislation(state, stateDataCache[state]);
          document.getElementById("loading").style.display = "none";
          return;
        }
        
        try {
          const apiKey = "57cf1119f6c9ebcb5d542458c87d85e7";
          const stateAbbr = stateNameToAbbreviation[state];

          console.log(`Fetching legislation for ${state} (${stateAbbr})`);

          // First, get the current session for the state
          const sessionUrl = `https://api.legiscan.com/?key=${apiKey}&op=getSessionList&state=${stateAbbr}`;
          const sessionResponse = await fetch(sessionUrl);
          const sessionData = await sessionResponse.json();

          console.log("Session data:", sessionData);

          if (
            sessionData.status !== "OK" ||
            !sessionData.sessions ||
            sessionData.sessions.length === 0
          ) {
            throw new Error("Failed to retrieve session information");
          }

          // Sort by session_id descending to get the most recent session
          const currentSession = sessionData.sessions.sort((a, b) => b.session_id - a.session_id)[0];

          console.log("Current session:", currentSession);

          // Now, perform the search using the session ID
          const query = encodeURIComponent(searchTerms.join(" OR "));
          const searchUrl = `https://api.legiscan.com/?key=${apiKey}&op=getSearch&state=${stateAbbr}&query=${query}&session=${currentSession.session_id}`;

          const searchResponse = await fetch(searchUrl);
          const searchData = await searchResponse.json();

          console.log("Search data:", searchData);

          if (searchData.status === "OK" && searchData.searchresult) {
            // Extract bill IDs from search results
            const billEntries = Object.entries(searchData.searchresult)
              .filter(([key, value]) => key !== "summary" && typeof value === "object");
            
            console.log(`Found ${billEntries.length} bills, fetching details in parallel...`);
            
            // Fetch all bills in parallel for much faster loading
            const billPromises = billEntries.map(async ([key, value]) => {
              try {
                const billUrl = `https://api.legiscan.com/?key=${apiKey}&op=getBill&id=${value.bill_id}`;
                const billResponse = await fetch(billUrl);
                const billData = await billResponse.json();
                if (billData.status === "OK") {
                  return { key, bill: billData.bill };
                }
                return null;
              } catch (error) {
                console.error(`Error fetching bill ${value.bill_id}:`, error);
                return null;
              }
            });
            
            // Wait for all bills to be fetched
            const billResults = await Promise.all(billPromises);
            
            // Convert to bills object
            const bills = {};
            billResults.forEach(result => {
              if (result) {
                bills[result.key] = result.bill;
              }
            });
            
            console.log("Bills data:", bills);

            const relevantBills = Object.values(bills)
              .filter(isRelevant)
              .sort((a, b) => {
                const dateA = new Date(
                  a.last_action_date || a.status_date || "1970-01-01"
                );
                const dateB = new Date(
                  b.last_action_date || b.status_date || "1970-01-01"
                );
                return dateB - dateA; // Sort descending (most recent first)
              });

            console.log(
              "Sorted bills:",
              relevantBills.map((b) => ({
                bill: b.bill_number,
                date: b.last_action_date || b.status_date,
              }))
            );

            // Cache the results
            stateDataCache[state] = relevantBills;
            
            displayLegislation(state, relevantBills);
          } else {
            console.log("No search results found");
            displayNoLegislation(state);
          }
        } catch (error) {
          console.error(`Error fetching data for ${state}:`, error);
          displayNoLegislation(state);
        }

        document.getElementById("loading").style.display = "none";
      };
      
      const stateNameElement = document.getElementById("state-name");

      const highlightState = (state) => {
        svg.selectAll(".state").classed("active", false);
        svg.select(`path[data-state="${state}"]`).classed("active", true);
        stateNameElement.textContent = state;
      };
      
      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(
        (data) => {
          const states = topojson.feature(data, data.objects.states);
          svg
            .selectAll(".state")
            .data(states.features)
            .enter()
            .append("path")
            .attr("class", "state")
            .attr("data-state", (d) => d.properties.name)
            .attr("d", path)
            .on("click", function (event, d) {
              const state = d.properties.name;
              document.getElementById("loading").style.display = "block";
              fetchLegislation(state);
              highlightState(state);
            });
        }
      );

      const displayLegislation = (state, bills) => {
        console.log(`Displaying legislation for ${state}:`, bills);

        const legislationContainer = document.getElementById(
          "regulations-container"
        );
        legislationContainer.innerHTML = "";

        const stateHeading = document.createElement("h2");
        stateHeading.textContent = `AI-related Legislation for ${state}:`;
        legislationContainer.appendChild(stateHeading);

        let billCount = 0;

        const statusMap = {
          1: "Introduced",
          2: "Engrossed",
          3: "Enrolled",
          4: "Passed",
          5: "Vetoed",
          6: "Failed",
        };

        bills.forEach((bill) => {
          console.log("Full bill object:", bill);
          billCount++;
          const billElement = document.createElement("div");
          billElement.classList.add("regulation");

          const title = bill.title || "Untitled Bill";
          const billNumber = bill.bill_number || "Unknown Bill Number";
          const stateLink = bill.state_link || "";
          const status = statusMap[bill.status] || "Unknown Status";

          // Use last_action_date or status_date
          let lastActionDate =
            bill.last_action_date || bill.status_date || "Unknown Date";

          // Format the date
          if (lastActionDate !== "Unknown Date") {
            const dateObj = new Date(lastActionDate);
            lastActionDate = dateObj.toLocaleDateString("en-US", {
              month: "long",
              day: "numeric",
              year: "numeric",
            });
          }

          const sponsors = bill.sponsors
            ? bill.sponsors.map((s) => s.name).join(", ")
            : "No sponsors listed";
          const description = bill.description || "No description available";

          const shortDescription =
            description.length > 300
              ? description.substring(0, 300) + "..."
              : description;

          billElement.innerHTML = `
      <h5>${billNumber}: ${title}</h5>
      <p><strong>Status:</strong> ${status}</p>
      <p><strong>Last Action Date:</strong> ${lastActionDate}</p>
      <p><strong>Description:</strong> ${shortDescription}</p>
      <button style="
        display: inline-block;
        outline: 0;
        border: none;
        cursor: pointer;
        height: 40px;
        padding: 12px 17px;
        border-radius: 50px;
        background-color: #2222220d;
        color: #222;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.3s ease;
      "
      onclick="window.open('${stateLink}', '_blank')"
      onmouseover="this.style.backgroundColor='#2222221a'"
      onmouseout="this.style.backgroundColor='#2222220d'"
      >
        Source
      </button>
    `;

          legislationContainer.appendChild(billElement);
        });

        const resultCount = document.createElement("p");
        resultCount.textContent = `Found ${billCount} results for ${state}`;
        legislationContainer.insertBefore(
          resultCount,
          legislationContainer.firstChild.nextSibling
        );

        if (billCount === 0) {
          displayNoLegislation(state);
        }
      };

      const displayNoLegislation = (state) => {
        const legislationContainer = document.getElementById(
          "regulations-container"
        );
        legislationContainer.innerHTML = `<p>No AI-related regulations found for ${state}.</p>`;
      };

      // World Map Code
      const worldWidth = 960;
      const worldHeight = 500;
      const worldSvg = d3
        .select("#world-map")
        .append("svg")
        .attr("width", worldWidth)
        .attr("height", worldHeight);

      const worldProjection = d3
        .geoNaturalEarth1()
        .scale(worldWidth / 2 / Math.PI)
        .translate([worldWidth / 2, worldHeight / 2]);
      const worldPath = d3.geoPath().projection(worldProjection);

      d3.json(
        "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"
      ).then((world) => {
        worldSvg
          .append("g")
          .selectAll("path")
          .data(topojson.feature(world, world.objects.countries).features)
          .enter()
          .append("path")
          .attr("d", worldPath)
          .attr("class", "country")
          .attr("id", (d) => (d.properties.name ? d.properties.name.replace(/\s+/g, "-") : "unknown"))
          .on("click", function (event, d) {
            d3.selectAll(".country").classed("active", false);
            d3.select(this).classed("active", true);
            const countryName = d.properties.name;
            
            const container = document.getElementById("worldwide-container");
            const countryLegislation = worldwideLegislationData.filter(
              (leg) => leg.country.toLowerCase() === countryName.toLowerCase()
            );

            if (countryLegislation.length > 0) {
              container.innerHTML = `
                <h3>${countryName} - ${countryLegislation.length} AI Regulation(s)</h3>
                ${countryLegislation
                  .map(
                    (leg) => `
                  <div class="country-legislation">
                      <h5>${leg.interventionName}</h5>
                      <p><strong>Status:</strong> ${leg.interventionStatus}</p>
                      <p><strong>Date:</strong> ${leg.eventDate}</p>
                      <p><strong>Type:</strong> ${leg.actionType}</p>
                      <p>${leg.eventDescription}</p>
                      <p><a href="${leg.SourceURL}" target="_blank">View Source</a></p>
                  </div>
                `
                  )
                  .join("")}
              `;
            } else {
              container.innerHTML = `<p>No AI-related regulations found for ${countryName} in our database.</p>`;
            }
          });
      });

      // IMPROVED: Load worldwide data with CORS proxy support and optional authentication
      async function loadWorldwideData(forceRefresh = false) {
        if (isLoadingWorldwideData) {
          console.log("Already loading data, skipping duplicate request");
          return;
        }
        
        // Check if running from file:// protocol
        if (window.location.protocol === 'file:') {
          const container = document.getElementById("worldwide-container");
          container.innerHTML = `
            <div class="error-message">
              <strong>‚ö†Ô∏è Local File System Detected</strong><br><br>
              This application needs to be served over HTTP to load external data.<br><br>
              <strong>Quick Solutions:</strong><br>
              1. <strong>Python:</strong> Run <code>python -m http.server 8000</code> in this folder, then visit <code>http://localhost:8000</code><br>
              2. <strong>Node.js:</strong> Install <code>npx http-server</code> and run it in this folder<br>
              3. <strong>VS Code:</strong> Install "Live Server" extension and click "Go Live"<br>
              4. <strong>Add API Key:</strong> Set <code>DPA_API_KEY</code> variable at line ~273 (see comments)<br><br>
              <em>Reason: CORS proxies require HTTP/HTTPS protocol, not file://</em>
            </div>
          `;
          isLoadingWorldwideData = false;
          return;
        }
        
        // Check cache first unless forcing refresh
        if (!forceRefresh && loadCachedData()) {
          const container = document.getElementById("worldwide-container");
          const uniqueCountries = [...new Set(worldwideLegislationData.map(d => d.country))].sort();
          container.innerHTML = `
            <div class="success-message">
              <strong>Data loaded from cache!</strong><br>
              ${worldwideLegislationData.length} AI-related regulations from ${uniqueCountries.length} countries/regions available.<br>
              Click on a country on the map to view specific regulations.<br><br>
              <button onclick="refreshWorldwideData()" style="
                display: inline-block;
                outline: 0;
                border: none;
                cursor: pointer;
                height: 40px;
                padding: 12px 17px;
                border-radius: 50px;
                background-color: #1fd1bf;
                color: white;
                font-size: 16px;
                font-weight: 500;
                transition: background-color 0.3s ease;
              "
              onmouseover="this.style.backgroundColor='#19b8a8'"
              onmouseout="this.style.backgroundColor='#1fd1bf'">
                Refresh Data
              </button>
            </div>
          `;
          return;
        }
        
        isLoadingWorldwideData = true;
        const container = document.getElementById("worldwide-container");
        container.innerHTML = '<div class="loading-progress">Loading AI regulations from Digital Policy Alerts...</div>';
        
        try {
          console.log("Starting data fetch from DPA...");
          
          const limit = 100;
          const maxPages = 10;
          let allData = [];
          
          // Decide which method to use based on API key availability
          if (DPA_API_KEY && DPA_API_KEY.trim() !== '') {
            console.log("Using authenticated API with policy_area filter...");
            allData = await fetchWithAuthentication(limit, maxPages, container);
          } else {
            console.log("Using public endpoint with CORS proxy...");
            allData = await fetchWithCorsProxy(limit, maxPages, container);
          }
          
          if (allData.length === 0) {
            container.innerHTML = `<div class="error-message">
              <strong>No data available</strong><br>
              The API returned no results.<br>
              Please try again later.
            </div>`;
            return;
          }
          
          // Log sample to see structure
          console.log("Sample raw data:", allData[0]);
          
          // Filter for AI content
          const aiRelatedData = filterAIContent(allData);
          console.log(`AI-related entries: ${aiRelatedData.length} out of ${allData.length} total`);
          
          // Transform the data
          const transformedData = transformDPAData(aiRelatedData);
          
          console.log("Sample transformed data:", transformedData.slice(0, 2));
          
          const uniqueCountries = [...new Set(transformedData.map(d => d.country))].sort();
          console.log(`Countries with data (${uniqueCountries.length}):`, uniqueCountries);
          
          worldwideLegislationData = transformedData;
          saveCacheData(transformedData);
          
          const apiMethod = DPA_API_KEY ? 'Authenticated API with policy_area=6 filter' : 'Public endpoint with CORS proxy';
          
          container.innerHTML = `
            <div class="success-message">
              <strong>‚úì Data loaded successfully!</strong><br>
              Loaded ${worldwideLegislationData.length} AI-related regulations from ${uniqueCountries.length} countries/regions.<br>
              <strong>Method:</strong> ${apiMethod}<br>
              <strong>Source links:</strong> Direct links to digitalpolicyalert.org/event/[ID]<br>
              Data cached for 24 hours.<br><br>
              Click on a country on the map to view specific regulations.<br><br>
              <button onclick="refreshWorldwideData()" style="
                display: inline-block;
                outline: 0;
                border: none;
                cursor: pointer;
                height: 40px;
                padding: 12px 17px;
                border-radius: 50px;
                background-color: #1fd1bf;
                color: white;
                font-size: 16px;
                font-weight: 500;
                transition: background-color 0.3s ease;
              "
              onmouseover="this.style.backgroundColor='#19b8a8'"
              onmouseout="this.style.backgroundColor='#1fd1bf'">
                Refresh Data
              </button>
            </div>
          `;
          
        } catch (error) {
          console.error("Error loading worldwide legislation data:", error);
          
          let errorHtml = `
            <div class="error-message">
              <strong>Error loading data:</strong><br>
              ${error.message}<br><br>
              Possible causes:<br>
              - CORS restrictions on the API<br>
              - Network connectivity issues<br>
              - API service temporarily unavailable<br>
              - Rate limits reached<br><br>
          `;
          
          if (!DPA_API_KEY) {
            errorHtml += `
              <strong>üí° Solution: Add Your API Key</strong><br>
              To use the more reliable authenticated API:<br>
              1. Get your free API key from <a href="https://digitalpolicyalert.org/account/api-keys" target="_blank">digitalpolicyalert.org/account/api-keys</a><br>
              2. In this file, find line ~273: <code>const DPA_API_KEY = '';</code><br>
              3. Add your key: <code>const DPA_API_KEY = 'your-key-here';</code><br>
              4. Refresh the page<br><br>
              <em>Note: Using public endpoint with CORS proxy (less reliable)</em><br><br>
            `;
          } else {
            errorHtml += `<strong>Note:</strong> Using authenticated API. Check if API key is valid.<br><br>`;
          }
          
          errorHtml += `Please try again later or check the browser console for more details.</div>`;
          container.innerHTML = errorHtml;
        } finally {
          isLoadingWorldwideData = false;
        }
      }
      
      // Fetch using authenticated API (requires API key)
      async function fetchWithAuthentication(limit, maxPages, container) {
        const apiUrl = "https://api.globaltradealert.org/api/v1/dpa/events/";
        
        const requestBody = {
          limit: limit,
          offset: 0,
          request_data: {
            policy_area: [6]  // 6 = Artificial Intelligence
          }
        };
        
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `APIKey ${DPA_API_KEY}`
        };
        
        // First request
        const firstResponse = await fetch(apiUrl, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });
        
        if (!firstResponse.ok) {
          throw new Error(`Authenticated API request failed with status ${firstResponse.status}. Check if API key is valid.`);
        }
        
        const firstData = await firstResponse.json();
        const totalCount = firstData.count || 0;
        const results = firstData.results || [];
        
        console.log(`Total AI interventions available: ${totalCount}`);
        console.log(`First page returned ${results.length} entries`);
        
        const totalPages = Math.min(maxPages, Math.ceil(totalCount / limit));
        const pagesToFetch = totalPages - 1;
        
        container.innerHTML = `<div class="loading-progress">
          <strong>Loading AI regulations...</strong><br>
          Loaded page 1 of ${totalPages} (${results.length} entries so far)<br>
          Using authenticated API with policy_area=6 filter
        </div>`;
        
        // Fetch remaining pages in parallel
        const fetchPromises = [];
        for (let page = 1; page <= pagesToFetch; page++) {
          const pageRequestBody = {
            limit: limit,
            offset: page * limit,
            request_data: { policy_area: [6] }
          };
          
          fetchPromises.push(
            fetch(apiUrl, {
              method: 'POST',
              headers: headers,
              body: JSON.stringify(pageRequestBody)
            })
              .then(response => response.ok ? response.json() : [])
              .then(data => {
                const pageResults = data.results || [];
                console.log(`Page ${page + 1} fetched: ${pageResults.length} entries`);
                return pageResults;
              })
              .catch(() => [])
          );
        }
        
        const additionalResults = await Promise.all(fetchPromises);
        return [results, ...additionalResults].flat();
      }
      
      // Fetch using public endpoint with CORS proxy (requires HTTP server)
      async function fetchWithCorsProxy(limit, maxPages, container) {
        // Try multiple CORS proxies in order of preference
        const corsProxies = [
          'https://corsproxy.io/?',
          'https://api.codetabs.com/v1/proxy?quest=',
          'https://api.allorigins.win/raw?url='
        ];
        
        const baseUrl = 'https://unctad.org/dpa-api/interventions';
        let lastError = null;
        
        // Try each proxy until one works
        for (const corsProxy of corsProxies) {
          try {
            console.log(`Trying CORS proxy: ${corsProxy.split('?')[0]}...`);
            
            const firstPageUrl = `${corsProxy}${encodeURIComponent(`${baseUrl}?limit=${limit}&offset=0`)}`;
            const firstResponse = await fetch(firstPageUrl);
            
            if (!firstResponse.ok) {
              throw new Error(`Status ${firstResponse.status}`);
            }
            
            const firstData = await firstResponse.json();
            let results = [];
            
            if (Array.isArray(firstData)) {
              results = firstData;
            } else if (firstData && firstData.results && Array.isArray(firstData.results)) {
              results = firstData.results;
            } else if (firstData && firstData.data && Array.isArray(firstData.data)) {
              results = firstData.data;
            }
            
            console.log(`‚úì Success with ${corsProxy.split('?')[0]} - First page returned ${results.length} results`);
            
            let pagesToFetch = Math.min(maxPages - 1, Math.ceil((1000 - limit) / limit));
            
            if (results.length < limit) {
              pagesToFetch = 0;
            }
            
            container.innerHTML = `<div class="loading-progress">
              <strong>Loading regulations...</strong><br>
              Loaded page 1 of up to ${pagesToFetch + 1} (${results.length} entries so far)<br>
              Using CORS proxy for public access
            </div>`;
            
            // Fetch remaining pages in parallel
            const fetchPromises = [];
            for (let page = 1; page <= pagesToFetch; page++) {
              const offset = page * limit;
              const pageUrl = `${corsProxy}${encodeURIComponent(`${baseUrl}?limit=${limit}&offset=${offset}`)}`;
              
              fetchPromises.push(
                fetch(pageUrl)
                  .then(response => response.ok ? response.json() : [])
                  .then(data => {
                    let pageResults = [];
                    if (Array.isArray(data)) {
                      pageResults = data;
                    } else if (data && data.results && Array.isArray(data.results)) {
                      pageResults = data.results;
                    } else if (data && data.data && Array.isArray(data.data)) {
                      pageResults = data.data;
                    }
                    console.log(`Page ${page + 1} fetched: ${pageResults.length} entries`);
                    return pageResults;
                  })
                  .catch(() => [])
              );
            }
            
            const additionalResults = await Promise.all(fetchPromises);
            return [results, ...additionalResults].flat();
            
          } catch (error) {
            console.warn(`Failed with ${corsProxy.split('?')[0]}: ${error.message}`);
            lastError = error;
            continue; // Try next proxy
          }
        }
        
        // All proxies failed
        throw new Error(`All CORS proxies failed. Last error: ${lastError?.message}. Try adding an API key or serving via HTTP server.`);
      }
      
      // Filter data for AI-related content
      function filterAIContent(allData) {
        const aiTerms = [
          'artificial intelligence',
          'machine learning',
          'ai ',
          ' ai',
          'neural network',
          'deep learning',
          'generative ai',
          'algorithmic',
          'automation',
          'ai-powered',
          'ai system',
          'ai model',
          'ai act',
          'ai regulation',
          'algorithm',
          'automated decision'
        ];
        
        return allData.filter(item => {
          // Check policy_area field (API docs: code 6 = "Artificial intelligence")
          const policyArea = item.policy_area || '';
          if (policyArea && typeof policyArea === 'string') {
            if (policyArea.toLowerCase().includes('artificial intelligence')) {
              return true;
            }
          }
          
          // Check policy_area_id
          if (item.policy_area_id === 6) {
            return true;
          }
          
          // Keyword search fallback
          const searchText = (
            (item.title || item.intervention_title || item.name || '') + ' ' +
            (item.description || item.intervention_description || '')
          ).toLowerCase();
          
          return aiTerms.some(term => searchText.includes(term));
        });
      }
      
      // Transform DPA API data to consistent format
      function transformDPAData(data) {
        return data.map(item => {
          // Extract country from implementers (API format from docs)
          let country = 'Unknown';
          if (item.implementers && item.implementers.length > 0) {
            country = item.implementers[0].name || item.implementers[0] || 'Unknown';
          } else if (item.implementing_country) {
            country = item.implementing_country;
          } else if (item.implementer_groups && item.implementer_groups.length > 0) {
            country = item.implementer_groups[0].name || item.implementer_groups[0];
          }
          
          const title = item.title || 'Untitled Event';
          const description = item.description || 'No description available';
          const eventDate = item.date || 'Unknown Date';
          const status = item.status || 'Unknown Status';
          const actionType = item.action_type || item.event_type || 'Policy Update';
          const policyArea = item.policy_area || '';
          const policyInstrument = item.policy_instrument || '';
          
          // URL from API docs: url field contains direct link
          let sourceUrl = item.url || '#';
          
          // Fallback: construct from ID
          if (sourceUrl === '#' && item.id) {
            sourceUrl = `https://digitalpolicyalert.org/event/${item.id}`;
          }
          
          return {
            country: country,
            interventionName: title,
            interventionStatus: status,
            eventDate: eventDate,
            eventDescription: description,
            actionType: actionType,
            policyArea: policyArea,
            policyInstrument: policyInstrument,
            SourceURL: sourceUrl,
            eventId: item.id || 'unknown'
          };
        });
      }

      // Navigation menu functionality
      document
        .getElementById("us-link")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("us").style.display = "block";
          document.getElementById("worldwide").style.display = "none";
          document.getElementById("us-footer").style.display = "block";
          document.getElementById("worldwide-footer").style.display = "none";
          this.classList.add("active");
          document.getElementById("worldwide-link").classList.remove("active");
        });

      document
        .getElementById("worldwide-link")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("us").style.display = "none";
          document.getElementById("worldwide").style.display = "block";
          document.getElementById("us-footer").style.display = "none";
          document.getElementById("worldwide-footer").style.display = "block";
          this.classList.add("active");
          document.getElementById("us-link").classList.remove("active");
          if (worldwideLegislationData.length === 0 && !isLoadingWorldwideData) {
            loadWorldwideData();
          } else if (worldwideLegislationData.length > 0) {
            const container = document.getElementById("worldwide-container");
            if (container.innerHTML === "") {
              const uniqueCountries = [...new Set(worldwideLegislationData.map(d => d.country))].sort();
              container.innerHTML = `
                <div class="success-message">
                  <strong>Data loaded from cache!</strong><br>
                  ${worldwideLegislationData.length} AI-related regulations from ${uniqueCountries.length} countries/regions available.<br>
                  Click on a country on the map to view specific regulations.<br><br>
                  <button onclick="refreshWorldwideData()" style="
                    display: inline-block;
                    outline: 0;
                    border: none;
                    cursor: pointer;
                    height: 40px;
                    padding: 12px 17px;
                    border-radius: 50px;
                    background-color: #1fd1bf;
                    color: white;
                    font-size: 16px;
                    font-weight: 500;
                    transition: background-color 0.3s ease;
                  "
                  onmouseover="this.style.backgroundColor='#19b8a8'"
                  onmouseout="this.style.backgroundColor='#1fd1bf'">
                    Refresh Data
                  </button>
                </div>
              `;
            }
          }
        });
      
      // Load cached data on page load
      loadCachedData();
      
      // Global function to refresh worldwide data
      window.refreshWorldwideData = function() {
        console.log("Manually refreshing worldwide data...");
        loadWorldwideData(true);
      };
    </script>
  </body>
</html>
